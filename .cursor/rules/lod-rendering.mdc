---
description: Level of Detail (LOD) rendering patterns for zoom-based performance
globs: ["**/*.tsx", "**/*.ts"]
---

# LOD (Level of Detail) Rendering

Carta uses a three-band LOD system to improve performance and readability at different zoom levels.

## Overview

As users zoom out to view large diagrams, rendering full node details becomes:
1. **Performance-intensive** - Too many DOM elements
2. **Visually cluttered** - Unreadable text and overlapping elements

The LOD system solves this by rendering simplified node representations at lower zoom levels.

## Three LOD Bands

### Pill Mode (zoom < 0.5)
**Purpose**: Maximum overview, minimal DOM complexity

**Rendering**:
- Single colored bar with schema type + display value
- 32px text with `text-halo` for legibility
- Minimal invisible handles (1px×1px) for connections
- No field rows, no header controls

**Use case**: Viewing entire architecture at a glance

### Minimal Mode (zoom 0.5-1.0)
**Purpose**: Middle ground - identify nodes without full detail

**Rendering**:
- Header bar with schema name
- Display value only (no field rows)
- Larger text (`text-node-lg`)
- Inline port handles (if `portDisplayPolicy: 'inline'`)

**Use case**: Navigating between clusters, understanding relationships

### Normal Mode (zoom ≥ 1.0)
**Purpose**: Full editing and detail view

**Rendering**:
- Header with expand/collapse controls
- All field rows (summary or details mode)
- Full port handles and tooltips
- Color picker and deployable selector (when expanded)

**Use case**: Editing node values, creating connections, full interaction

## Implementation

### LOD Policy Configuration

File: `src/components/lod/lodPolicy.ts`

```typescript
export type LodBand = 'pill' | 'minimal' | 'normal';

export interface LodBandConfig {
  band: LodBand;
  minZoom: number; // inclusive
  maxZoom: number; // exclusive
}

export const DEFAULT_LOD_POLICY: LodBandConfig[] = [
  { band: 'pill', minZoom: 0, maxZoom: 0.5 },
  { band: 'minimal', minZoom: 0.5, maxZoom: 1.0 },
  { band: 'normal', minZoom: 1.0, maxZoom: Infinity },
];
```

**Pure data structure** - No React, easy to test and modify.

### LOD Hook

File: `src/components/lod/useLodBand.ts`

```typescript
import { useStore } from '@xyflow/react';
import { getLodConfig, DEFAULT_LOD_POLICY } from './lodPolicy';

// Selector returns discrete band string -> nodes only re-render on threshold crossing
const bandSelector = (state: { transform: [number, number, number] }) =>
  getLodConfig(state.transform[2]).band;

export function useLodBand(): LodBandConfig {
  const band = useStore(bandSelector);
  return DEFAULT_LOD_POLICY.find((c) => c.band === band)!;
}
```

**Key insight**: Returns discrete band string, not continuous zoom value. Nodes only re-render when crossing band thresholds (0.5, 1.0), not on every zoom change.

### Using LOD in Components

File: `src/components/ConstructNode.tsx`

```typescript
import { useLodBand } from './lod/useLodBand';

const ConstructNode = memo(({ data, selected }: ConstructNodeComponentProps) => {
  const lod = useLodBand();
  
  // Pill mode: minimal colored bar
  if (lod.band === 'pill') {
    return (
      <div className="text-halo" style={{ backgroundColor: schema.color }}>
        {schema.displayName}: {displayValue}
      </div>
    );
  }
  
  // Minimal mode: header + display value only
  if (lod.band === 'minimal') {
    return (
      <div>
        <div className="text-halo" style={{ backgroundColor: schema.color }}>
          {schema.displayName}
        </div>
        <div>{displayValue}</div>
      </div>
    );
  }
  
  // Normal mode: full rendering
  return (/* full node JSX */);
});
```

## Text Legibility

All LOD modes apply the `text-halo` utility class to header text for consistent legibility on colored backgrounds:

```css
@utility text-halo {
  text-shadow:
    0 2px 12px rgba(0, 0, 0, 0.8),
    0 4px 24px rgba(0, 0, 0, 0.6),
    0 8px 48px rgba(0, 0, 0, 0.4);
}
```

This creates readable white text without requiring dynamic color contrast switching.

## Zoom Controls

Custom zoom controls in `Map.tsx` provide finer granularity:

- **Zoom step**: 1.15x (vs React Flow default 1.2x)
- **Min zoom**: 0.15 (vs default 0.5) - allows deeper zoom-out
- **Custom buttons**: Replace default React Flow zoom controls

## Performance Benefits

1. **Reduced DOM complexity**: Pill mode renders ~90% fewer elements than normal mode
2. **Discrete re-renders**: Nodes only re-render on band threshold crossings, not continuous zoom
3. **Early exit rendering**: Pill/compact modes return early, avoiding expensive field row logic

## Debugging

Temporary `ZoomDebug` component in `Map.tsx` shows current zoom and LOD band (bottom-left corner):

```typescript
function ZoomDebug() {
  const zoom = useStore((state) => state.transform[2]);
  const lod = getLodConfig(zoom);
  return (
    <div className="absolute bottom-8 left-2 bg-black/80 text-white">
      <div>Zoom: {zoom.toFixed(3)}</div>
      <div>LOD: {lod.band}</div>
    </div>
  );
}
```

**Remove this component** before production release.

## Design Principles

1. **Discrete bands over continuous scaling** - Prevents constant re-renders
2. **Pure data configuration** - Policy is data, not code
3. **Early exit rendering** - Simpler modes return JSX early
4. **Consistent legibility** - `text-halo` works at all zoom levels
5. **Invisible functional handles** - Connections work even when handles are visually hidden

## Future Enhancements

- User-configurable LOD thresholds (settings modal)
- Per-schema LOD overrides (some schemas stay detailed longer)
- Virtualized rendering for 1000+ node diagrams
- LOD for VirtualParentNode (currently only ConstructNode)
