#!/bin/bash
# Prepare context for task-master
# Concatenates all pending tasks and clarification responses into one file
# Usage: ./tasks/prepare

TASKS_DIR="$(dirname "$0")"
INPUTS_DIR="$TASKS_DIR/inputs"
CLARIFICATIONS_DIR="$TASKS_DIR/clarifications"
CONTEXT_FILE="$TASKS_DIR/context.md"
PREPARED_FILE="$TASKS_DIR/.prepared-context.md"

# Count pending tasks
pending_count=$(ls -1 "$INPUTS_DIR"/*.txt 2>/dev/null | wc -l)

if [ "$pending_count" -eq 0 ]; then
  echo "No pending tasks in $INPUTS_DIR"
  exit 0
fi

echo "Preparing context for $pending_count task(s)..."

# Start building prepared context
cat > "$PREPARED_FILE" << 'EOF'
# Task Master Context

## Instructions
You are task-master. Process each task below and delegate to the appropriate agent.
- TEST tasks → spawn test-builder (sonnet)
- IMPLEMENTATION tasks → spawn task-executor (haiku)
- UNCLEAR → write to /tasks/clarifications/{slug}.md

EOF

# Add codebase context if exists
if [ -f "$CONTEXT_FILE" ]; then
  echo "## Codebase Context" >> "$PREPARED_FILE"
  echo "" >> "$PREPARED_FILE"
  cat "$CONTEXT_FILE" >> "$PREPARED_FILE"
  echo "" >> "$PREPARED_FILE"
fi

# Add clarification responses (if user answered any)
if [ -d "$CLARIFICATIONS_DIR" ]; then
  answered=$(grep -l '^>>' "$CLARIFICATIONS_DIR"/*.md 2>/dev/null)
  if [ -n "$answered" ]; then
    echo "## Clarification Responses" >> "$PREPARED_FILE"
    echo "" >> "$PREPARED_FILE"
    for f in $answered; do
      echo "### $(basename "$f" .md)" >> "$PREPARED_FILE"
      cat "$f" >> "$PREPARED_FILE"
      echo "" >> "$PREPARED_FILE"
    done
  fi
fi

# Add all pending tasks
echo "## Pending Tasks" >> "$PREPARED_FILE"
echo "" >> "$PREPARED_FILE"

for f in "$INPUTS_DIR"/*.txt; do
  [ -f "$f" ] || continue
  echo "### $(basename "$f")" >> "$PREPARED_FILE"
  echo '```' >> "$PREPARED_FILE"
  cat "$f" >> "$PREPARED_FILE"
  echo '```' >> "$PREPARED_FILE"
  echo "" >> "$PREPARED_FILE"
done

echo "Prepared: $PREPARED_FILE"
echo ""
echo "To run task-master with this context:"
echo "  cat $PREPARED_FILE"
