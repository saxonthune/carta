#!/bin/bash

# Use script's directory as base (works from anywhere)
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
TASK_DIR="$SCRIPT_DIR/inputs"
mkdir -p "$TASK_DIR"

# Find the lowest available number
n=1
while [[ -f "$TASK_DIR/$n.txt" ]]; do
    ((n++))
done

TASK="$*"

# Auto-detect type from keywords
# Check for BOTH first (impl + test in same task)
if echo "$TASK" | grep -qiE '(and.*(test|cover)|then.*(test|cover)|with.*(test|cover)|\+\s*test|test.*too|also.*test)'; then
    TYPE="BOTH"
elif echo "$TASK" | grep -qiE '(add test|write test|test for|e2e|integration test|regression)'; then
    TYPE="TEST"
else
    TYPE="IMPL"
fi

# Extract file hint (first .tsx/.ts/.css/.md reference)
FILE_HINT=$(echo "$TASK" | grep -oE '[a-zA-Z0-9_/-]+\.(tsx?|css|md|json)' | head -1)

# Write structured task
cat > "$TASK_DIR/$n.txt" << EOF
# Type: $TYPE
# File: ${FILE_HINT:-none}
# ---
$TASK
EOF

echo "Created $TASK_DIR/$n.txt (${TYPE}${FILE_HINT:+, $FILE_HINT})"
